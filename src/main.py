import streamlit as st
from datetime import datetime
import pandas as pd
import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å Python
sys.path.insert(0, os.path.abspath(os.path.dirname(os.path.dirname(__file__))))

from src.utils.data_fetcher import DataFetcher, PortfolioDataManager
from src.utils.calculations import PortfolioAnalytics
from src.utils.risk_management import RiskManagement
from src.utils.visualization import PortfolioVisualization
import src.config as config
from src.pages import portfolio_creation, portfolio_analysis, portfolio_optimization
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º",
    page_icon="üíº",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏
if 'current_page' not in st.session_state:
    st.session_state.current_page = "–ì–ª–∞–≤–Ω–∞—è"


def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    data_fetcher = DataFetcher(cache_dir=str(config.CACHE_DIR), cache_expiry_days=config.CACHE_EXPIRY_DAYS)
    portfolio_manager = PortfolioDataManager(data_fetcher, storage_dir=str(config.PORTFOLIO_DIR))

    # –ó–∞–¥–∞–µ–º API –∫–ª—é—á–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if config.ALPHA_VANTAGE_API_KEY:
        data_fetcher.api_keys['alpha_vantage'] = config.ALPHA_VANTAGE_API_KEY

    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    st.sidebar.title("–ù–∞–≤–∏–≥–∞—Ü–∏—è")

    # –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü
    pages = [
        "–ì–ª–∞–≤–Ω–∞—è",
        "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è",
        "–ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è",
        "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è"
    ]

    # –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    selected_page = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", pages)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
    st.session_state.current_page = selected_page

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if selected_page == "–ì–ª–∞–≤–Ω–∞—è":
        show_home_page(data_fetcher, portfolio_manager)
    elif selected_page == "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è":
        portfolio_creation.run(data_fetcher, portfolio_manager)
    elif selected_page == "–ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è":
        portfolio_analysis.run(data_fetcher, portfolio_manager)
    elif selected_page == "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è":
        portfolio_optimization.run(data_fetcher, portfolio_manager)

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    with st.sidebar.expander("–û –ø—Ä–æ–≥—Ä–∞–º–º–µ"):
        st.write("""
        **–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º** –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å, 
        –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ—Ä—Ç—Ñ–µ–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º 
        —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏ –º–æ–¥–µ–ª–µ–π.

        –ê–≤—Ç–æ—Ä: –ò–º—è –ê–≤—Ç–æ—Ä–∞
        –í–µ—Ä—Å–∏—è: 1.0.0
        """)

    # –°—Ç–∞—Ç—É—Å API
    with st.sidebar.expander("–°—Ç–∞—Ç—É—Å API"):
        if config.ALPHA_VANTAGE_API_KEY:
            st.success("Alpha Vantage API: –ü–æ–¥–∫–ª—é—á–µ–Ω–æ")
        else:
            st.warning("Alpha Vantage API: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ")

        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤—ã–∑–æ–≤–æ–≤ API
        st.write("–°—á–µ—Ç—á–∏–∫–∏ –≤—ã–∑–æ–≤–æ–≤ API:")
        st.write(f"- yFinance: {data_fetcher.api_call_counts['yfinance']}")
        st.write(f"- Alpha Vantage: {data_fetcher.api_call_counts['alpha_vantage']}")

        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞
        if st.button("–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –¥–∞–Ω–Ω—ã—Ö"):
            data_fetcher.clear_cache()
            st.success("–ö–µ—à –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω!")


def show_home_page(data_fetcher, portfolio_manager):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

    Args:
        data_fetcher: –≠–∫–∑–µ–º–ø–ª—è—Ä DataFetcher –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        portfolio_manager: –≠–∫–∑–µ–º–ø–ª—è—Ä PortfolioDataManager –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏
    """
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    st.title("–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º")

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    st.write("""
    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º! 

    –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ 
    –ø–æ—Ä—Ç—Ñ–µ–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
    """)

    # –†–∞–∑–¥–µ–ª—è–µ–º —ç–∫—Ä–∞–Ω –Ω–∞ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏
    col1, col2 = st.columns(2)

    with col1:
        # –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π
        st.subheader("–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã")

        st.markdown("""
        #### üìà –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è
        - –†—É—á–Ω–æ–π –≤–≤–æ–¥ —Ç–∏–∫–µ—Ä–æ–≤ –∏ –≤–µ—Å–æ–≤
        - –ò–º–ø–æ—Ä—Ç –∏–∑ CSV-—Ñ–∞–π–ª–∞
        - –ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        - –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é

        #### üìä –ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è
        - –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –∏ —Ä–∏—Å–∫–∞
        - –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–∞–º–∏
        - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        - –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

        #### üîç –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
        - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –º–µ—Ç–æ–¥–∞–º (–ú–∞—Ä–∫–æ–≤–∏—Ü, —Ä–∞–≤–Ω—ã–π —Ä–∏—Å–∫ –∏ —Ç.–¥.)
        - –¢–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤
        - –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ —Å–∏–º—É–ª—è—Ü–∏—è
        """)

    with col2:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        portfolios = portfolio_manager.list_portfolios()

        st.subheader("–í–∞—à–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–∏")

        if portfolios:
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏
            portfolios_df = pd.DataFrame({
                '–ù–∞–∑–≤–∞–Ω–∏–µ': [p['name'] for p in portfolios],
                '–ê–∫—Ç–∏–≤–æ–≤': [p['asset_count'] for p in portfolios],
                '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ': [p['last_updated'] for p in portfolios]
            })

            st.dataframe(portfolios_df, use_container_width=True)

            # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            st.subheader("–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è")

            col1, col2 = st.columns(2)

            with col1:
                if st.button("–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å"):
                    st.session_state.current_page = "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è"
                    st.experimental_rerun()

            with col2:
                if st.button("–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π"):
                    st.session_state.current_page = "–ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è"
                    st.experimental_rerun()
        else:
            st.info("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π. –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è.")

            if st.button("–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å"):
                st.session_state.current_page = "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è"
                st.experimental_rerun()

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è
    st.subheader("–ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É")

    with st.expander("–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö"):
        st.write("""
        ### –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

        1. **–°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å**: –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –º–µ—Ç–æ–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è:
           - –†—É—á–Ω–æ–π –≤–≤–æ–¥ —Ç–∏–∫–µ—Ä–æ–≤ –∏ –≤–µ—Å–æ–≤
           - –ò–º–ø–æ—Ä—Ç –∏–∑ CSV-—Ñ–∞–π–ª–∞
           - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞

        2. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å**: –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è" –¥–ª—è
           –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π, –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –∏ –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤.

        3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å**: –í —Ä–∞–∑–¥–µ–ª–µ "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è" –≤—ã –º–æ–∂–µ—Ç–µ —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å,
           –∏—Å–ø–æ–ª—å–∑—É—è —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤ –∏–ª–∏
           –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—É–¥—É—â—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ —Å–∏–º—É–ª—è—Ü–∏–∏.
        """)


if __name__ == "__main__":
    main()